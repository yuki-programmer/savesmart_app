# SaveSmart 機能一覧

## 概要

SaveSmartは「今日使えるお金」を軸にした家計管理アプリ。給料日ベースのサイクル管理で、日々の支出を3段階評価（節約/標準/ご褒美）で記録し、予算ペースを可視化する。

---

## 1. 初期設定フロー

### 1.1 給料日設定（Settings）
- 毎月の家計開始日を1〜28日から選択
- 設定した日から翌給料日前日までが1サイクル
- 例: 25日設定 → 1/25〜2/24が1月のサイクル

### 1.2 今月の予算設定（Home）
- 「今月使えるお金」をタップして金額入力
- この金額がサイクル全体の予算となる

### 1.3 固定費登録（Home）
- 家賃、光熱費、サブスクなど毎月固定の支出を登録
- 予算から自動差し引きされ、変動費の可処分額を算出

---

## 2. ホーム画面（Home）

### 2.1 今日使えるお金（メイン表示）
- **計算式**: (予算 - 固定費 - 昨日までの支出) ÷ 残り日数
- 毎朝0時に固定値として保存（日中は変動しない）
- 支出登録ごとに「明日の予測」がリアルタイム更新

### 2.2 明日の予測
- 現在の支出ペースで計算した明日の日割り額
- 今日の予算より増加 → 緑（節約成功）
- 今日の予算より減少 → 赤（使いすぎ）
- サイクル最終日は「今月もあと1日！」と表示

### 2.3 クイック登録
- よく使う支出パターンを事前登録
- ワンタップで支出記録（タイトル/金額/カテゴリ/グレード）
- 長押しで編集モーダル

### 2.4 今日の支出リスト
- 今日登録した支出を時系列表示
- タップで編集/分割/削除のアクションシート

---

## 3. 支出登録（Add）

### 3.1 金額入力
- テンキーで金額入力
- 「+」ボタンで加算入力（レシートまとめ登録）

### 3.2 グレード選択（3段階）
| グレード | 意味 | 色 |
|---------|------|-----|
| 節約 | 我慢・代替・安い選択 | 緑 |
| 標準 | 普通の支出 | 青 |
| ご褒美 | 自分へのご褒美・贅沢 | オレンジ |

### 3.3 カテゴリ選択
- 食費、日用品、交通費、趣味・娯楽、交際費、衣服・美容、健康、その他
- カテゴリ別の分析に使用

### 3.4 スマートコンボ
- カテゴリ選択後、過去の金額×グレードの組み合わせをチップ表示
- タップで自動入力

### 3.5 メモ（任意）
- 自由テキストで詳細記録
- 履歴画面の検索対象

---

## 4. 履歴画面（History）

### 4.1 タイムライン表示
- サイクル開始日から今日まで全日程を縦表示
- 支出がない日も「記録なし」として表示
- 2カラム構成: 日付 | 支出内容

### 4.2 支出詳細
- 各支出にグレード色のアイコン表示
- 金額、カテゴリ、メモを表示

### 4.3 検索機能
- カテゴリ名/メモで絞り込み
- 検索中はフラットリスト表示

### 4.4 支出編集
- タップでアクションシート表示
- 編集: 金額/グレード/カテゴリ/メモを修正
- 分割: 1件を複数件に分割
- 削除: 支出を削除

---

## 5. 分析画面（Analytics）

### 5.1 今サイクルのまとめ
- サイクル期間（例: 1/25〜2/24）を表示
- 支出合計（変動費 + 固定費）
- 残りの使える金額

### 5.2 消費ペースグラフ（バーンレート）
- **Premiumのみ**
- X軸: サイクル日数、Y軸: 消費率(%)
- 理想ライン（均等消費）と実績を比較
- 100%超 = 予算オーバー

### 5.3 日割り・週割りペース
- **Premiumのみ**
- カテゴリ別の日割り/週割り支出額
- 支出総額降順でソート

### 5.4 家計の余白
- **Premiumのみ**
- 今のペースで月末まで使える余剰額
- アップグレード可能なカテゴリ提案

### 5.5 カテゴリ別支出
- **Premiumのみ**
- 円グラフでカテゴリ比率を可視化
- カテゴリ別の支出額リスト

---

## 6. 設定画面（Settings）

### 6.1 家計設定
- 家計の開始日（給料日）変更

### 6.2 アプリ情報
- バージョン表示
- プラン表示（Free / Premium）

### 6.3 開発者オプション（Dev Only）
- バージョン10回タップで解放
- Premium override（強制ON/OFF）
- Releaseビルドでは非表示

---

## 7. 固定費管理

### 7.1 固定費一覧（Home）
- 登録済み固定費をリスト表示
- 合計額を自動計算

### 7.2 固定費登録
- 項目名、金額、カテゴリを入力
- カテゴリ: 住居、光熱費、通信、保険、サブスク、その他

### 7.3 固定費編集/削除
- タップで編集モーダル
- 削除ボタンで削除

---

## 8. データ管理

### 8.1 ローカルDB（SQLite）
- 支出データ: expenses テーブル
- 固定費データ: fixed_costs テーブル
- クイック登録: quick_entries テーブル
- 日別予算: daily_budgets テーブル

### 8.2 SharedPreferences
- 今月の予算（monthly_amount_YYYY_MM）
- 給料日設定（main_salary_day）
- Premium状態
- 開発者モード設定

---

## 9. FinancialCycle（給料日サイクル）

### 9.1 サイクル計算
- 給料日から翌給料日前日までを1サイクルとして管理
- 月末日が存在しない月は自動調整（31日設定で2月→28/29日）

### 9.2 サイクルキー
- フォーマット: `cycle_YYYY_MM_DD`（開始日ベース）
- 予算・収入データの紐付けに使用

### 9.3 日数計算
- 残り日数: 今日からサイクル終了日まで（今日含む）
- 経過日数: サイクル開始日から今日まで

---

## 10. Premium機能

### 10.1 Free版で使える機能
- 今日使えるお金の表示
- 支出登録（グレード/カテゴリ/メモ）
- 履歴閲覧・検索
- 固定費管理
- クイック登録
- 今サイクルのまとめ（支出合計のみ）

### 10.2 Premium限定機能
- 消費ペースグラフ
- 日割り・週割りペース分析
- 家計の余白計算
- カテゴリ別円グラフ

---

## 11. 収入管理システム（Phase 2 実装済み）

### 11.1 cycle_incomes テーブル
- `id`: 主キー
- `cycle_key`: サイクル識別子（例: `cycle_2025_01_25`）
- `is_main`: メイン収入フラグ（1=給料、0=サブ収入）
- `name`: 収入名（給料、ボーナス、副業など）
- `amount`: 金額（円）
- `created_at`: 登録日時

### 11.2 収入登録UI（income_sheet.dart）
- メイン収入（給料）: 1サイクルに1件、更新可能
- サブ収入（補填・ボーナス等）: 複数件追加可能、削除可能
- 収入合計をリアルタイム表示
- サイクル期間を表示

### 11.3 DB一元管理
- SharedPreferencesからDBへ自動移行（初回起動時）
- `thisMonthAvailableAmount`はDBの収入合計から計算
- 収入変更時に今日の固定予算を自動再計算

### 11.4 Refill機能
- サブ収入追加時に日割り額が自動再計算
- `_reloadCycleIncome()` → `_recalculateTodayAllowance()`

---

## 12. 前サイクル比較機能（Phase 3-A 実装済み）

### 12.1 FinancialCycle拡張
- `getPreviousCycleKey()`: 前サイクルのキーを取得
- `getPreviousCycleStartDate()`: 前サイクルの開始日を取得
- `getPreviousCycleEndDate()`: 前サイクルの終了日を取得
- `getPreviousCycleTotalDays()`: 前サイクルの総日数を取得

### 12.2 サイクル別支出集計（DatabaseService）
- `getDailyExpensesByCycle()`: 指定期間の日ごとの支出合計を取得
- `getTotalExpensesByCycle()`: 指定期間の支出合計を取得

### 12.3 前サイクルデータ取得（AppState）
- `getPreviousCycleBurnRateData()`: 前サイクルの累積支出率を計算
  - 返り値: `{ rates, startDay, totalDays, income, disposable, totalExpenses }`
  - 記録日数3日以上で比較線表示
- `getCycleComparisonDiff()`: 今サイクルと前サイクルの同時点での差額を計算
  - 正の値 = 今サイクルの方が支出が少ない（節約中）
  - 負の値 = 今サイクルの方が支出が多い（使いすぎ）

### 12.4 支出ペースグラフ（BurnRateChart）
- **今サイクル線**: 青の実線
- **前サイクル線**: グレーの点線（記録日数3日以上で表示）
- **理想線**: グレーの点線（前サイクルデータがない場合のフォールバック）
- 凡例: 「今サイクル」「前サイクル」または「理想」

### 12.5 前サイクル比較バッジ
- 前サイクル同時点との差額を表示
- 節約中（緑）: `前サイクル比 -¥5,000（節約中）`
- 使いすぎ（オレンジ）: `前サイクル比 +¥3,000（使いすぎ）`
- グラフ上部に表示

### 12.6 日数補間
- サイクル日数が異なる場合でも正確に比較
- 進捗率ベースの補間: `prevEquivalentDay = progress * prevTotalDays`

---

## 13. 全履歴表示機能（Phase 3-B 実装済み）

### 13.1 DatabaseService拡張
- `getAllExpensesPaged(limit, offset)`: 全支出をページネーションで取得
- `getAllExpensesCount()`: 全支出の総件数を取得
- `searchExpensesPaged(query, limit, offset)`: 全期間検索（ページネーション対応）
- `searchExpensesCount(query)`: 検索結果の総件数を取得

### 13.2 履歴画面の全期間開放
- 現在のサイクルに限定されていた表示制限を撤廃
- 全履歴をスクロールで閲覧可能
- ヘッダーに「全 N 件」と総件数を表示

### 13.3 サイクル境界ヘッダー
- サイクルの変わり目に境界線（ヘッダー）を表示
- フォーマット: `YYYY/MM/DD 〜 YYYY/MM/DD`
- 表示条件: `HeaderVisible(i) = true if i=0 or CycleKey(i) ≠ CycleKey(i-1)`
- 青系のアクセントカラーでスタイリング

### 13.4 無限スクロール（Lazy Loading）
- 初回ロード: 50件
- スクロール末尾200px手前で追加ロード
- ローディングインジケーター表示
- `_hasMore`フラグで追加ロード可否を管理

### 13.5 全期間検索
- 検索対象: カテゴリ名・メモ（部分一致）
- 検索結果もページネーション対応
- 検索結果にもサイクル境界ヘッダーを表示
- 検索結果件数をUIに表示

### 13.6 UI変更点
- 検索バーのヒントテキスト: 「カテゴリ・メモで検索（全期間）」
- 日付表示: 月初日と今日に「○月」ラベルを追加
- ボトムシートに日付表示を追加（過去データの編集時に分かりやすく）
- 削除・編集後は履歴リストも自動リロード

---

## 14. Night Reflection（Phase 4 実装済み）

### 14.1 概要
- 夜の時間帯に「今日のふりかえり」体験を提供
- 今日の支出と明日の予算（日割り）を確認できる

### 14.2 表示条件（時間ベース切り替え）
- **19:00〜23:59**: 常に夜カード表示（支出があっても維持）
- **00:00〜03:59**: 今日の支出が0円の場合のみ夜カード表示
- **04:00〜18:59**: 常に日中カード表示
- 条件判定: `NightReflectionDialog.shouldShowNightCard(hasTodayExpense: bool)`

### 14.3 夜の振り返りカード（HomeScreen）
- ダークネイビー系背景（#1E2340）
- 🌙 アイコン + 「今日のふりかえり」タイトル
- 今日の支出と明日の予算（日割り）を並列表示
- 「タップして振り返る」ヒント表示
- タップでフルスクリーンダイアログを表示（回数制限なし）

### 14.4 振り返りダイアログ（NightReflectionDialog）
- `showGeneralDialog`で表示
- 背景: 0.85暗転（ダークネイビー #1A1F3C）
- アニメーション: 300msのフェード + 下から上への微細スライド
- コンテンツ:
  - 今日の総支出（`appState.todayTotal`）
  - 明日の予算（日割り）（`dynamicTomorrowForecast`）大きく表示
  - メッセージ:
    - 支出0: 「今日はお金を使わない日でした。素晴らしい！」
    - 支出あり: 「今日もお疲れさま。明日はこの金額を目安にいこう。」
- 閉じるボタンのみ（戻るボタン/×ボタンなし）
- 何度でも表示可能（1日1回制限なし）
